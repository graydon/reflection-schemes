(define (navigate-context xs exp)
  (if (null? xs)
      exp
      (if (existsi exp (car xs))
          (navigate-context (cdr xs) (geti exp (car xs)))
          ':none)))

(define (orfun . args)
  (if (null? args)
      #f
      (if (car args)
          #t
          (apply orfun (cdr args)))))

;; meta-circular evaluator
(define (meta-ev-exp more-cases)
  `(begin
    (set! _ctx (get this '(:ctx) '()))
    (set! _e (navigate-context (reverse _ctx) (get this '(:exp))))
    (if (eq? _e ':none)
        (begin
          (set! _ctx (cdr _ctx))
          (set! _e (navigate-context (reverse _ctx) (get this '(:exp))))))
    (set! _pending (get this '(:pending) '()))
    (set!
     _next-ctx
     (if (null? _ctx)
         '()
         (cons (+ 1 (car _ctx)) (cdr _ctx))))
    (if (symbol? _e)
        (begin
          (set! _result (get this (list ':env _e)))
          (set! _ctx _next-ctx))
        (if (orfun (number? _e) (boolean? _e) (string? _e))
            (begin
              (set! _result _e)
              (set! _ctx _next-ctx))
            (if (orfun
                 (tagged? '+ _e)
                 (tagged? '- _e)
                 (tagged? '* _e)
                 (tagged? '= _e)
                 (tagged? '< _e)
                 (tagged? '<= _e)
                 (tagged? 'not _e)
                 (tagged? 'cons _e)
                 (tagged? 'car _e)
                 (tagged? 'cdr _e)
                 (tagged? 'dict _e)
                 (tagged? 'copy _e)
                 (tagged? 'display _e)
                 (tagged? 'newline _e)
                 (tagged? 'list _e)
                 (tagged? 'null? _e)
                 (tagged? 'length _e)
                 (tagged? 'reverse _e)
                 (tagged? 'symbol? _e)
                 (tagged? 'number? _e)
                 (tagged? 'boolean? _e)
                 (tagged? 'tagged? _e)
                 (tagged? 'apply _e)
                 (tagged? 'eval _e)
                 (tagged? 'error _e)
                 (tagged? 'existsi _e)
                 (tagged? 'geti _e)
                 (tagged? 'orfun _e)
                 (tagged? 'navigate-context _e)
                 (tagged? 'format _e))
                (if (= (length _pending) (length (cdr _e)))
                    (begin
                      (set! _result
                            (apply
                             (eval (car _e))
                             (reverse _pending)))
                      (set! _pending '())
                      (set! _ctx _next-ctx))
                    (set! _ctx (cons 1 _ctx)))
                (if (tagged? 'set! _e)
                    (if (= (length _pending) 1)
                        (begin
                          (set! _x (geti _e 1))
                          (set! _v (geti _pending 0))
                          (upd! this (list ':env _x) _v)
                          (set! _pending '())
                          (set! _ctx _next-ctx))
                        (set! _ctx (cons 2 _ctx)))
                    (if (tagged? 'get _e)
                        (if (= (length _pending) (length (cdr _e)))
                            (begin
                              (set! _pending (cons 'get (reverse _pending)))
                              (set! _dict (geti _pending 1))
                              (set! _selector (geti _pending 2))
                              (if (existsi _e 3)
                                  (set! _result (get _dict _selector (geti _pending 3)))
                                  (set! _result (get _dict _selector)))
                              (set! _pending '())
                              (set! _ctx _next-ctx))
                            (set! _ctx (cons 1 _ctx)))
                        (if (tagged? 'upd! _e)
                            (if (= (length _pending) (length (cdr _e)))
                                (begin
                                  (set! _pending (cons 'upd! (reverse _pending)))
                                  (set! _dict (geti _pending 1))
                                  (set! _selector (geti _pending 2))
                                  (set! _val (geti _pending 3))
                                  (upd! _dict _selector _val)
                                  (set! _pending '())
                                  (set! _ctx _next-ctx))
                                (set! _ctx (cons 1 _ctx)))
                            (if (tagged? 'quote _e)
                                (begin
                                  (set! _result (geti _e 1))
                                  (set! _ctx _next-ctx))
                                (if (tagged? 'if _e)
                                    (if (= (length _pending) 1)
                                        (if (geti _pending 0)
                                            (set! _ctx (cons 2 _ctx))
                                            (set! _ctx (cons 3 _ctx)))
                                        (if (= (length _pending) 2)
                                            (begin
                                              (set! _result (geti _pending 0))
                                              (set! _pending '())
                                              (set! _ctx _next-ctx))
                                            (set! _ctx (cons 1 _ctx))))
                                    (if (tagged? 'begin _e)
                                        (if (= (length _pending) (length (cdr _e)))
                                            (begin
                                              (set! _result (car pending))
                                              (set! _pending '())
                                              (set! _ctx _next-ctx))
                                            (set! _ctx (cons 1 _ctx)))
                                        (if (tagged? 'this _e)
                                            (begin
                                              (set! _result this)
                                              (set! _ctx next-ctx))
                                            ,(more-cases '(error 'evl (format "unknown expression ~a" _e)))))))))))))
    (if (orfun (not (null? _ctx)) (not (null? _pending)))
        (begin
          (upd! this '(:pending) (cons _result _pending))
          (upd! this '(:ctx) _ctx))
        (begin
          (upd! this '(:pending) '())
          (upd! this '(:env :result) _result)
          (upd! this '(:env :done) #t)))))

(define meta-ev
  (eval `(lambda (this) ,(meta-ev-exp (lambda (x) x)))))
